{% extends 'base.html' %}

{% block content %}
<div id="flash-messages" style="position: fixed; top: 100px; left: 10px; z-index: 10000 !important;"></div>

<div class="container-fluid papaya-dashboard papaya-wide">
  <div class="papaya-card papaya-hero-card">
    <div class="papaya-card-body">
      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center">
        <div>
          <p class="papaya-eyebrow mb-2">Account Overview</p>
          <h1 class="papaya-title mb-2">Welcome, {{ current_user.username }}!</h1>
          <p class="papaya-muted mb-0">Wallet: {{ current_user.id }}</p>
        </div>
        <a class="papaya-button mt-3 mt-lg-0" href="{{ mm_url_for('logout') }}">Logout</a>
      </div>
    </div>
  </div>

  <div class="papaya-kpis">
    <div class="papaya-card">
      <div class="papaya-card-body">
        <p class="papaya-muted mb-1">Total Supplied</p>
        <div class="papaya-kpi">{{ "{:,.0f}".format(total_supplied_usd|float) }} USD</div>
      </div>
    </div>
    <div class="papaya-card">
      <div class="papaya-card-body">
        <p class="papaya-muted mb-1">Total Borrowed</p>
        <div class="papaya-kpi">{{ "{:,.0f}".format(total_borrowed_usd|float) }} USD</div>
      </div>
    </div>
    <div class="papaya-card">
      <div class="papaya-card-body">
        <p class="papaya-muted mb-1">Net Assets</p>
        <div class="papaya-kpi">{{ "{:,.0f}".format(net_assets_usd|float) }} USD</div>
      </div>
    </div>
  </div>

  <div class="row papaya-row">
    <div class="col-12 col-lg-6 papaya-col">
      <div class="papaya-card">
        <div class="papaya-card-header d-flex align-items-center justify-content-between">
          <h2 class="papaya-section-title">Supplied Assets</h2>
          <a class="papaya-button papaya-button-ghost" href="{{ mm_url_for('deposit', asset='EUR') }}">Deposit</a>
        </div>
        <div class="table-responsive">
          <table class="table papaya-table papaya-table-compact papaya-table-stretch">
            <thead>
              <tr>
                <th scope="col">Asset</th>
                <th scope="col">Balance</th>
                <th scope="col">Current APR</th>
                <th scope="col">Accrued Interest</th>
                <th scope="col">Withdraw</th>
              </tr>
            </thead>
            <tbody>
              {% for asset, balance in total_assets.items() %}
              <tr>
                <td class="papaya-market">
                  <span class="papaya-asset-icon" aria-hidden="true">{{ asset[0] }}</span>
                  <span class="papaya-asset-name">{{ asset }}</span>
                </td>
                <td class="papaya-number">{{ "{:,.2f}".format(balance|float) }}</td>
                <td class="papaya-number">{{ "{:,.2f}".format(apy[asset]|float) }}%</td>
                <td class="papaya-number">{{ "{:,.4f}".format(supplied_yield[asset]|float) }}</td>
                <td><a class="papaya-button papaya-button-ghost" href="{{ mm_url_for('withdraw', asset=asset) }}">Withdraw</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6 papaya-col">
      <div class="papaya-card">
        <div class="papaya-card-header">
          <h2 class="papaya-section-title">Borrowed Assets</h2>
        </div>
        <div class="table-responsive">
          <table class="table papaya-table papaya-table-compact papaya-table-stretch">
            <thead>
              <tr>
                <th scope="col">Asset</th>
                <th scope="col">Borrowed</th>
                <th scope="col">Accrued Interest</th>
                <th scope="col">Pay Back</th>
                <th scope="col">Borrow</th>
              </tr>
            </thead>
            <tbody>
              {% for asset, balance in borrowed_assets.items() %}
              <tr>
                <td class="papaya-market">
                  <span class="papaya-asset-icon" aria-hidden="true">{{ asset[0] }}</span>
                  <span class="papaya-asset-name">{{ asset }}</span>
                </td>
                <td class="papaya-number">{{ "{:,.2f}".format(balance|float) }}</td>
                <td class="papaya-number">{{ "{:,.4f}".format(borrowed_interest[asset]|float) }}</td>
                <td><a class="papaya-button papaya-button-ghost" href="{{ mm_url_for('payback', asset=asset) }}">Pay Back</a></td>
                <td><a class="papaya-button" href="{{ mm_url_for('borrow', asset=asset) }}">Borrow</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<section class="papaya-section">
  <div class="container">
    <div class="papaya-card">
      <div class="papaya-card-header">
        <h2 class="papaya-section-title">Liquidations</h2>
      </div>
      <div class="table-responsive">
        <table class="table papaya-table papaya-table-compact">
          <thead>
            <tr>
              <th>Asset</th>
              <th>Amount</th>
              <th>Date</th>
            </tr>
          </thead>
          {% if liquidations %}
          <tbody>
            {% for liquidation in liquidations %}
            <tr>
              <td class="papaya-market">
                <span class="papaya-asset-icon" aria-hidden="true">{{ liquidation[1][0] }}</span>
                <span class="papaya-asset-name">{{ liquidation[1] }}</span>
              </td>
              <td class="papaya-number">{{ "{:,.2f}".format(liquidation[2]|float) }}</td>
              <td class="papaya-number">{{ liquidation[3] }}</td>
            </tr>
            {% endfor %}
          </tbody>
          {% else %}
          <tbody>
            <tr>
              <td colspan="3" class="text-center papaya-muted">If there is a liquidation event, it will show up here.</td>
            </tr>
          </tbody>
          {% endif %}
        </table>
      </div>
    </div>
  </div>
</section>
<audio id="coinSound" src="{{ mm_url_for('static', filename='audio/coin.wav') }}" preload="auto"></audio>

<!-- JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script>
    var userId = "{{ user_id }}";  // Get the user ID passed from Flask
    var protocol = location.protocol;
    var ws_url = protocol + '//' + document.domain + (location.port ? ':' + location.port : '');
    var socket = io.connect(ws_url, {path: "/mm/socket.io"});
    socket.on('connect', function() {
        socket.emit('join', {user_id: userId});  // Send a join event with the user ID
    });
    socket.on('deposit', function(data) {
    // Displaying a message about the deposit
    var depositMessage = "Deposited " + data.amount + " " + data.asset;
    var depositMessageElement = document.createElement('div');
    depositMessageElement.classList.add('alert', 'alert-success');
    depositMessageElement.textContent = depositMessage;

    var flashMessagesContainer = document.getElementById('flash-messages');
    flashMessagesContainer.appendChild(depositMessageElement);

    // Play the coin sound
    document.getElementById('coinSound').play();

    // Set the timeout function within the scope of the event listener
    setTimeout(function() {
        flashMessagesContainer.removeChild(depositMessageElement);
    }, 5000);  // Removes the message after 5 seconds
    setTimeout(function() {
        location.reload();
    }, 1000);
});

</script>
{% endblock %}
